<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hustle Incognito Test UI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge {
      font-size: 0.7em;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: normal;
    }
    .badge.streaming {
      background: #10b981;
      color: white;
    }
    .badge.non-streaming {
      background: #3b82f6;
      color: white;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #374151;
      font-weight: 500;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      width: 100%;
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .response-box {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .response-box.streaming {
      background: #f0fdf4;
      border-color: #86efac;
    }
    .loading {
      color: #667eea;
      font-style: italic;
    }
    .error {
      color: #dc2626;
      background: #fee2e2;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .success {
      color: #059669;
    }
    .meta {
      margin-top: 10px;
      padding: 10px;
      background: #eff6ff;
      border-radius: 6px;
      font-size: 12px;
      color: #1e40af;
    }
    .event-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 5px;
    }
    .event-text { background: #dbeafe; color: #1e40af; }
    .event-tool { background: #fef3c7; color: #92400e; }
    .event-finish { background: #d1fae5; color: #065f46; }
    .settings-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }
    .settings-toggle {
      text-align: right;
      margin-bottom: 15px;
    }
    .toggle-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .toggle-btn:hover {
      background: #5568d3;
    }
    .settings-content {
      display: none;
    }
    .settings-content.visible {
      display: block;
    }
    .save-btn {
      margin-top: 15px;
      background: #10b981;
    }
    .save-btn:hover {
      background: #059669;
    }
    .tools-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .tools-content {
      display: none;
    }
    .tools-content.visible {
      display: block;
    }
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .tool-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tool-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    .tool-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .tool-card.disabled {
      opacity: 0.5;
      background: #f9fafb;
    }
    .tool-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .tool-title {
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tool-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .tool-description {
      font-size: 13px;
      color: #6b7280;
      margin-top: 5px;
    }
    .tool-id {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 5px;
      font-family: 'Courier New', monospace;
    }
    .premium-badge {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    .tool-type-header {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-top: 20px;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    .tool-type-header:first-child {
      margin-top: 0;
    }
    .loading-tools {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }
    .file-upload-area {
      margin-top: 10px;
      padding: 10px;
      background: #f9fafb;
      border: 2px dashed #e5e7eb;
      border-radius: 8px;
    }
    .file-upload-area.has-file {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .file-input {
      display: none;
    }
    .file-upload-label {
      display: inline-block;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-right: 10px;
    }
    .file-upload-label:hover {
      background: #5568d3;
    }
    .uploaded-files {
      margin-top: 10px;
    }
    .uploaded-file {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      background: white;
      border-radius: 6px;
      margin-top: 5px;
    }
    .uploaded-file-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .uploaded-file-name {
      font-size: 14px;
      color: #374151;
    }
    .uploaded-file-size {
      font-size: 12px;
      color: #6b7280;
    }
    .remove-file-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .remove-file-btn:hover {
      background: #dc2626;
    }
    .attachment-preview {
      max-width: 60px;
      max-height: 60px;
      border-radius: 4px;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Hustle Incognito Test UI</h1>

    <!-- Settings Panel -->
    <div class="settings-panel">
      <div class="settings-toggle">
        <button class="toggle-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
      </div>
      <div id="settingsContent" class="settings-content">
        <h2 style="margin-bottom: 15px;">Configuration</h2>
        <div class="settings-grid">
          <div class="input-group">
            <label for="apiKey">API Key</label>
            <input type="password" id="apiKey" placeholder="Enter API key">
          </div>
          <div class="input-group">
            <label for="baseUrl">Base URL</label>
            <input type="text" id="baseUrl" placeholder="https://agenthustle.ai">
          </div>
          <div class="input-group">
            <label for="defaultVaultId">Default Vault ID</label>
            <input type="text" id="defaultVaultId" placeholder="default">
          </div>
        </div>
        <button class="save-btn" onclick="saveSettings()">üíæ Save Settings</button>
      </div>
    </div>

    <!-- Tools Panel -->
    <div class="tools-panel">
      <div class="settings-toggle">
        <button class="toggle-btn" onclick="toggleTools()">üîß Tool Selection</button>
      </div>
      <div id="toolsContent" class="tools-content">
        <h2 style="margin-bottom: 15px;">Available Tool Categories</h2>
        <div id="toolsLoader" class="loading-tools">Loading tools...</div>
        <div id="toolsList" style="display: none;"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Non-Streaming Panel -->
      <div class="panel">
        <h2>
          Non-Streaming Chat
          <span class="badge non-streaming">Standard</span>
        </h2>
        <form id="nonStreamForm">
          <div class="input-group">
            <label for="systemPrompt1">System Prompt (optional)</label>
            <textarea id="systemPrompt1" placeholder="You are a helpful AI assistant expert in blockchain and cryptocurrency..." rows="3"></textarea>
          </div>
          <div class="input-group">
            <label for="message1">Message</label>
            <textarea id="message1" placeholder="What is Solana?" required></textarea>
          </div>
          <div class="input-group">
            <label for="vaultId1">Vault ID</label>
            <input type="text" id="vaultId1" value="default" placeholder="default">
          </div>
          <div class="file-upload-area" id="uploadArea1">
            <input type="file" id="fileInput1" class="file-input" accept="image/*" multiple>
            <label for="fileInput1" class="file-upload-label">üìé Attach Images</label>
            <span id="fileCount1" style="font-size: 14px; color: #6b7280;"></span>
            <div id="uploadedFiles1" class="uploaded-files"></div>
          </div>
          <button type="submit" id="submitBtn1">Send Message</button>
        </form>
        <div id="response1" class="response-box">Response will appear here...</div>
      </div>

      <!-- Streaming Panel -->
      <div class="panel">
        <h2>
          Streaming Chat
          <span class="badge streaming">SSE</span>
        </h2>
        <form id="streamForm">
          <div class="input-group">
            <label for="systemPrompt2">System Prompt (optional)</label>
            <textarea id="systemPrompt2" placeholder="You are a helpful AI assistant expert in blockchain and cryptocurrency..." rows="3"></textarea>
          </div>
          <div class="input-group">
            <label for="message2">Message</label>
            <textarea id="message2" placeholder="Tell me about Solana tokens" required></textarea>
          </div>
          <div class="input-group">
            <label for="vaultId2">Vault ID</label>
            <input type="text" id="vaultId2" value="default" placeholder="default">
          </div>
          <div class="file-upload-area" id="uploadArea2">
            <input type="file" id="fileInput2" class="file-input" accept="image/*" multiple>
            <label for="fileInput2" class="file-upload-label">üìé Attach Images</label>
            <span id="fileCount2" style="font-size: 14px; color: #6b7280;"></span>
            <div id="uploadedFiles2" class="uploaded-files"></div>
          </div>
          <button type="submit" id="submitBtn2">Stream Message</button>
        </form>
        <div id="response2" class="response-box streaming">Streaming response will appear here...</div>
      </div>
    </div>
  </div>

  <script>
    // Configuration - Update these for your setup
    const API_BASE_URL = window.location.origin; // Uses the same server by default
    const DEFAULT_VAULT_ID = '{{VAULT_ID_PLACEHOLDER}}'; // This will be replaced by the server

    // Load settings from localStorage
    window.loadSettings = function loadSettings() {
      const apiKey = localStorage.getItem('hustle_api_key') || '';
      const baseUrl = localStorage.getItem('hustle_base_url') || '';
      const defaultVaultId = localStorage.getItem('hustle_vault_id') || DEFAULT_VAULT_ID;

      document.getElementById('apiKey').value = apiKey;
      document.getElementById('baseUrl').value = baseUrl;
      document.getElementById('defaultVaultId').value = defaultVaultId;

      // Pre-fill vault ID fields
      document.getElementById('vaultId1').value = defaultVaultId;
      document.getElementById('vaultId2').value = defaultVaultId;
    }

    // Save settings to localStorage
    window.saveSettings = function saveSettings() {
      const apiKey = document.getElementById('apiKey').value;
      const baseUrl = document.getElementById('baseUrl').value;
      const defaultVaultId = document.getElementById('defaultVaultId').value;

      localStorage.setItem('hustle_api_key', apiKey);
      localStorage.setItem('hustle_base_url', baseUrl);
      localStorage.setItem('hustle_vault_id', defaultVaultId);

      // Update vault ID fields
      document.getElementById('vaultId1').value = defaultVaultId;
      document.getElementById('vaultId2').value = defaultVaultId;

      alert('Settings saved! ‚úì');
    }

    // Toggle settings visibility
    window.toggleSettings = function toggleSettings() {
      const content = document.getElementById('settingsContent');
      content.classList.toggle('visible');
    }

    // Get current settings
    function getCurrentSettings() {
      return {
        apiKey: localStorage.getItem('hustle_api_key') || '',
        baseUrl: localStorage.getItem('hustle_base_url') || '',
        vaultId: localStorage.getItem('hustle_vault_id') || DEFAULT_VAULT_ID
      };
    }

    // Load settings on page load
    loadSettings();

    // Tools management
    let availableTools = [];
    let selectedToolIds = [];

    // Load selected tools from localStorage
    function loadToolSelection() {
      const saved = localStorage.getItem('hustle_selected_tools');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          // Validate that it's an array of strings (tool IDs)
          if (Array.isArray(parsed) && parsed.every(id => typeof id === 'string')) {
            // Filter out any invalid values like 'required'
            selectedToolIds = parsed.filter(id => id !== 'required');
            // If we filtered out invalid values, update localStorage
            if (selectedToolIds.length !== parsed.length) {
              localStorage.setItem('hustle_selected_tools', JSON.stringify(selectedToolIds));
              console.log('Cleaned up invalid tool selections from localStorage');
            }
          } else {
            // Invalid format, reset
            selectedToolIds = [];
            localStorage.removeItem('hustle_selected_tools');
            console.log('Reset invalid tool selection format in localStorage');
          }
        } catch (e) {
          // Invalid JSON, reset
          selectedToolIds = [];
          localStorage.removeItem('hustle_selected_tools');
          console.log('Reset corrupted tool selection in localStorage');
        }
      } else {
        selectedToolIds = [];
      }

      // Don't force any tools to be selected

      console.log('Loaded tool selection from localStorage:', selectedToolIds);
    }

    // Toggle tool selection and auto-save
    window.toggleTool = function toggleTool(toolId) {
      // Load current selection from localStorage to ensure we have the latest
      const saved = localStorage.getItem('hustle_selected_tools');
      selectedToolIds = saved ? JSON.parse(saved) : [];

      const index = selectedToolIds.indexOf(toolId);
      if (index > -1) {
        selectedToolIds.splice(index, 1);
      } else {
        selectedToolIds.push(toolId);
      }

      // Save to localStorage immediately
      localStorage.setItem('hustle_selected_tools', JSON.stringify(selectedToolIds));
      console.log('Auto-saved tool selection:', selectedToolIds);

      renderTools();
    }

    // Render tools UI
    function renderTools() {
      const toolsList = document.getElementById('toolsList');
      if (availableTools.length === 0) return;

      // Group tools by type
      const analystTools = availableTools.filter(t => t.type === 'analyst');
      const traderTools = availableTools.filter(t => t.type === 'trader');
      const otherTools = availableTools.filter(t => t.type !== 'analyst' && t.type !== 'trader');

      let html = '';

      if (analystTools.length > 0) {
        html += '<div class="tool-type-header">üìä Analyst Tools</div>';
        html += '<div class="tools-grid">';
        analystTools.forEach(tool => {
          const isSelected = selectedToolIds.includes(tool.id);
          const isDisabled = tool.disabled || false;
          html += `
            <div class="tool-card ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
                 onclick="${!isDisabled ? `toggleTool('${tool.id}')` : ''}">
              <div class="tool-header">
                <div class="tool-title">
                  <input type="checkbox" class="tool-checkbox" ${isSelected ? 'checked' : ''}
                         ${isDisabled ? 'disabled' : ''}>
                  ${tool.title}
                  ${tool.premium ? '<span class="premium-badge">üíé Premium</span>' : ''}
                </div>
              </div>
              <div class="tool-description">${tool.description || 'No description'}</div>
              <div class="tool-id">ID: ${tool.id}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      if (traderTools.length > 0) {
        html += '<div class="tool-type-header">üíπ Trader Tools</div>';
        html += '<div class="tools-grid">';
        traderTools.forEach(tool => {
          const isSelected = selectedToolIds.includes(tool.id);
          const isDisabled = tool.disabled || false;
          const isRequired = tool.id === 'standard-tools' || tool.id === 'trader-standard-tools';
          html += `
            <div class="tool-card ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
                 onclick="${!isDisabled && !isRequired ? `toggleTool('${tool.id}')` : ''}">
              <div class="tool-header">
                <div class="tool-title">
                  <input type="checkbox" class="tool-checkbox" ${isSelected ? 'checked' : ''}
                         ${isDisabled || isRequired ? 'disabled' : ''}>
                  ${tool.title}
                  ${isRequired ? '<span class="premium-badge" style="background: #10b981;">Required</span>' : ''}
                  ${tool.premium && !isRequired ? '<span class="premium-badge">üíé Premium</span>' : ''}
                </div>
              </div>
              <div class="tool-description">${tool.description || 'No description'}</div>
              <div class="tool-id">ID: ${tool.id}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      if (otherTools.length > 0) {
        html += '<div class="tool-type-header">üîß Other Tools</div>';
        html += '<div class="tools-grid">';
        otherTools.forEach(tool => {
          const isSelected = selectedToolIds.includes(tool.id);
          const isDisabled = tool.disabled || false;
          html += `
            <div class="tool-card ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
                 onclick="${!isDisabled ? `toggleTool('${tool.id}')` : ''}">
              <div class="tool-header">
                <div class="tool-title">
                  <input type="checkbox" class="tool-checkbox" ${isSelected ? 'checked' : ''}
                         ${isDisabled ? 'disabled' : ''}>
                  ${tool.title}
                  ${tool.premium ? '<span class="premium-badge">üíé Premium</span>' : ''}
                </div>
              </div>
              <div class="tool-description">${tool.description || 'No description'}</div>
              <div class="tool-id">ID: ${tool.id}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      toolsList.innerHTML = html;
    }

    // Fetch available tools
    async function fetchTools() {
      try {
        const settings = getCurrentSettings();
        const headers = {};

        if (settings.apiKey) {
          headers['X-API-Key'] = settings.apiKey;
        }
        if (settings.baseUrl) {
          headers['X-Base-URL'] = settings.baseUrl;
        }

        const response = await fetch(`${API_BASE_URL}/api/tools`, { headers });
        const data = await response.json();

        if (response.ok) {
          availableTools = data.tools || [];
          document.getElementById('toolsLoader').style.display = 'none';
          document.getElementById('toolsList').style.display = 'block';
          // Load saved selection before rendering
          loadToolSelection();
          renderTools();
        } else {
          throw new Error(data.error || 'Failed to fetch tools');
        }
      } catch (error) {
        document.getElementById('toolsLoader').innerHTML = `<div class="error">Error loading tools: ${error.message}</div>`;
      }
    }

    // Toggle tools visibility
    window.toggleTools = function toggleTools() {
      const content = document.getElementById('toolsContent');
      const isVisible = content.classList.toggle('visible');

      // Fetch tools when first opened
      if (isVisible && availableTools.length === 0) {
        fetchTools();
      }
    }

    // Load tool selection on page load
    loadToolSelection();

    // Load settings on page load
    loadSettings();

    // File upload handling
    let uploadedAttachments1 = [];
    let uploadedAttachments2 = [];

    // Handle file selection for panel 1
    document.getElementById('fileInput1').addEventListener('change', async function(e) {
      await handleFileUpload(e.target.files, 1);
    });

    // Handle file selection for panel 2
    document.getElementById('fileInput2').addEventListener('change', async function(e) {
      await handleFileUpload(e.target.files, 2);
    });

    // Upload files and manage attachments
    async function handleFileUpload(files, panelNum) {
      const uploadArea = document.getElementById(`uploadArea${panelNum}`);
      const fileCount = document.getElementById(`fileCount${panelNum}`);
      const uploadedFilesDiv = document.getElementById(`uploadedFiles${panelNum}`);
      const attachments = panelNum === 1 ? uploadedAttachments1 : uploadedAttachments2;

      for (let file of files) {
        if (!file.type.startsWith('image/')) {
          alert(`File ${file.name} is not an image. Only images are supported.`);
          continue;
        }

        // Show uploading status
        fileCount.textContent = 'Uploading...';

        try {
          // Upload file to server
          const formData = new FormData();
          formData.append('file', file);

          const settings = getCurrentSettings();
          const headers = {};

          if (settings.apiKey) {
            headers['X-API-Key'] = settings.apiKey;
          }
          if (settings.baseUrl) {
            headers['X-Base-URL'] = settings.baseUrl;
          }

          const response = await fetch('/api/upload', {
            method: 'POST',
            headers: headers,
            body: formData
          });

          const result = await response.json();

          if (response.ok && result.success) {
            // Add to attachments
            attachments.push(result.attachment);

            // Create preview element
            const fileDiv = document.createElement('div');
            fileDiv.className = 'uploaded-file';
            fileDiv.innerHTML = `
              <div class="uploaded-file-info">
                <img src="${result.attachment.url}" alt="${result.attachment.name}" class="attachment-preview">
                <div>
                  <div class="uploaded-file-name">${result.attachment.name}</div>
                  <div class="uploaded-file-size">${formatFileSize(file.size)}</div>
                </div>
              </div>
              <button class="remove-file-btn" onclick="removeAttachment(${panelNum}, '${result.attachment.url}')">Remove</button>
            `;
            uploadedFilesDiv.appendChild(fileDiv);

            uploadArea.classList.add('has-file');
          } else {
            throw new Error(result.error || 'Upload failed');
          }
        } catch (error) {
          console.error('Upload error:', error);
          alert(`Failed to upload ${file.name}: ${error.message}`);
        }
      }

      // Update file count
      const count = attachments.length;
      fileCount.textContent = count > 0 ? `${count} file(s) attached` : '';

      // Clear the file input
      document.getElementById(`fileInput${panelNum}`).value = '';
    }

    // Remove attachment
    window.removeAttachment = function(panelNum, url) {
      const attachments = panelNum === 1 ? uploadedAttachments1 : uploadedAttachments2;
      const index = attachments.findIndex(a => a.url === url);

      if (index > -1) {
        attachments.splice(index, 1);
      }

      // Rebuild UI
      const uploadedFilesDiv = document.getElementById(`uploadedFiles${panelNum}`);
      const uploadArea = document.getElementById(`uploadArea${panelNum}`);
      const fileCount = document.getElementById(`fileCount${panelNum}`);

      uploadedFilesDiv.innerHTML = '';
      attachments.forEach(attachment => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'uploaded-file';
        fileDiv.innerHTML = `
          <div class="uploaded-file-info">
            <img src="${attachment.url}" alt="${attachment.name}" class="attachment-preview">
            <div>
              <div class="uploaded-file-name">${attachment.name}</div>
            </div>
          </div>
          <button class="remove-file-btn" onclick="removeAttachment(${panelNum}, '${attachment.url}')">Remove</button>
        `;
        uploadedFilesDiv.appendChild(fileDiv);
      });

      // Update file count
      const count = attachments.length;
      fileCount.textContent = count > 0 ? `${count} file(s) attached` : '';

      if (count === 0) {
        uploadArea.classList.remove('has-file');
      }
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Non-streaming form handler
    document.getElementById('nonStreamForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const message = document.getElementById('message1').value;
      const systemPrompt = document.getElementById('systemPrompt1').value;
      const vaultId = document.getElementById('vaultId1').value;
      const responseBox = document.getElementById('response1');
      const submitBtn = document.getElementById('submitBtn1');

      responseBox.textContent = 'Sending request...';
      responseBox.className = 'response-box loading';
      submitBtn.disabled = true;

      try {
        const settings = getCurrentSettings();
        const headers = { 'Content-Type': 'application/json' };

        // Add custom headers if settings are provided
        if (settings.apiKey) {
          headers['X-API-Key'] = settings.apiKey;
        }
        if (settings.baseUrl) {
          headers['X-Base-URL'] = settings.baseUrl;
        }

        const requestBody = { message, vaultId };
        if (systemPrompt && systemPrompt.trim()) {
          requestBody.systemPrompt = systemPrompt.trim();
        }

        // Load selected tools from localStorage and add to request
        const savedTools = localStorage.getItem('hustle_selected_tools');
        const currentSelectedTools = savedTools ? JSON.parse(savedTools) : [];

        // Add selected tools if any
        if (currentSelectedTools.length > 0) {
          requestBody.selectedToolCategories = currentSelectedTools;
          console.log('Including selected tools in request:', currentSelectedTools);
        }

        // Add attachments if any
        if (uploadedAttachments1.length > 0) {
          requestBody.attachments = uploadedAttachments1;
          console.log('Including attachments in request:', uploadedAttachments1.length);
        }

        const response = await fetch(`${API_BASE_URL}/api/chat`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        if (response.ok) {
          responseBox.className = 'response-box success';
          responseBox.innerHTML = '';

          // Display main response content
          if (data.content) {
            const contentDiv = document.createElement('div');
            contentDiv.textContent = data.content;
            responseBox.appendChild(contentDiv);
          }

          // Display tool calls if any
          if (data.toolCalls && data.toolCalls.length > 0) {
            const toolsSection = document.createElement('div');
            toolsSection.style.marginTop = '15px';

            const toolsHeader = document.createElement('div');
            toolsHeader.style.fontWeight = 'bold';
            toolsHeader.style.marginBottom = '8px';
            toolsHeader.style.color = '#92400e';
            toolsHeader.textContent = 'üîß Tool Calls:';
            toolsSection.appendChild(toolsHeader);

            data.toolCalls.forEach((tool, index) => {
              const toolDiv = document.createElement('div');
              toolDiv.style.marginLeft = '10px';
              toolDiv.style.marginBottom = '8px';
              toolDiv.style.padding = '8px';
              toolDiv.style.background = '#fef3c7';
              toolDiv.style.borderRadius = '4px';
              toolDiv.style.fontSize = '12px';

              const toolName = document.createElement('div');
              toolName.style.fontWeight = '600';
              toolName.textContent = `${index + 1}. ${tool.toolName || 'Unknown'}`;
              toolDiv.appendChild(toolName);

              if (tool.args && Object.keys(tool.args).length > 0) {
                const argsDiv = document.createElement('div');
                argsDiv.style.fontSize = '11px';
                argsDiv.style.color = '#6b7280';
                argsDiv.style.marginTop = '4px';
                argsDiv.textContent = 'Args: ' + JSON.stringify(tool.args);
                toolDiv.appendChild(argsDiv);
              }

              toolsSection.appendChild(toolDiv);
            });

            responseBox.appendChild(toolsSection);
          }

          // Display tool results if any
          if (data.toolResults && data.toolResults.length > 0) {
            const resultsSection = document.createElement('div');
            resultsSection.style.marginTop = '10px';

            const resultsHeader = document.createElement('div');
            resultsHeader.style.fontWeight = 'bold';
            resultsHeader.style.marginBottom = '8px';
            resultsHeader.style.color = '#065f46';
            resultsHeader.textContent = 'üìã Tool Results:';
            resultsSection.appendChild(resultsHeader);

            data.toolResults.forEach((result, index) => {
              const resultDiv = document.createElement('div');
              resultDiv.style.marginLeft = '10px';
              resultDiv.style.marginBottom = '8px';
              resultDiv.style.padding = '8px';
              resultDiv.style.background = '#d1fae5';
              resultDiv.style.borderRadius = '4px';
              resultDiv.style.fontSize = '12px';

              const resultHeader = document.createElement('div');
              resultHeader.style.fontWeight = '600';
              resultHeader.textContent = `${index + 1}. Result for: ${result.toolName || 'Unknown'}`;
              resultDiv.appendChild(resultHeader);

              if (result.result) {
                const resultContent = document.createElement('div');
                resultContent.style.fontSize = '11px';
                resultContent.style.color = '#374151';
                resultContent.style.marginTop = '4px';
                resultContent.style.maxHeight = '100px';
                resultContent.style.overflow = 'auto';
                resultContent.textContent = typeof result.result === 'string'
                  ? result.result
                  : JSON.stringify(result.result, null, 2);
                resultDiv.appendChild(resultContent);
              }

              resultsSection.appendChild(resultDiv);
            });

            responseBox.appendChild(resultsSection);
          }

          // Display metadata
          if (data.messageId || data.usage || data.pathInfo) {
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.innerHTML = `
              ${data.messageId ? `<div><strong>Message ID:</strong> ${data.messageId}</div>` : ''}
              ${data.toolCalls?.length ? `<div><strong>Total Tool Calls:</strong> ${data.toolCalls.length}</div>` : ''}
              ${data.usage?.total_tokens ? `<div><strong>Total Tokens:</strong> ${data.usage.total_tokens}</div>` : ''}
              ${data.pathInfo ? `<div><strong>Path:</strong> ${data.pathInfo.path || 'N/A'}</div>` : ''}
            `;
            responseBox.appendChild(meta);
          }
        } else {
          throw new Error(data.error || 'Request failed');
        }
      } catch (error) {
        responseBox.className = 'response-box';
        responseBox.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Streaming form handler
    document.getElementById('streamForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const message = document.getElementById('message2').value;
      const systemPrompt = document.getElementById('systemPrompt2').value;
      const vaultId = document.getElementById('vaultId2').value;
      const responseBox = document.getElementById('response2');
      const submitBtn = document.getElementById('submitBtn2');

      responseBox.textContent = 'Connecting to stream...';
      responseBox.className = 'response-box streaming loading';
      submitBtn.disabled = true;

      try {
        const settings = getCurrentSettings();
        const headers = { 'Content-Type': 'application/json' };

        // Add custom headers if settings are provided
        if (settings.apiKey) {
          headers['X-API-Key'] = settings.apiKey;
        }
        if (settings.baseUrl) {
          headers['X-Base-URL'] = settings.baseUrl;
        }

        const requestBody = { message, vaultId };
        if (systemPrompt && systemPrompt.trim()) {
          requestBody.systemPrompt = systemPrompt.trim();
        }

        // Load selected tools from localStorage and add to request
        const savedTools = localStorage.getItem('hustle_selected_tools');
        const currentSelectedTools = savedTools ? JSON.parse(savedTools) : [];

        // Add selected tools if any
        if (currentSelectedTools.length > 0) {
          requestBody.selectedToolCategories = currentSelectedTools;
          console.log('Including selected tools in streaming request:', currentSelectedTools);
        }

        // Add attachments if any
        if (uploadedAttachments2.length > 0) {
          requestBody.attachments = uploadedAttachments2;
          console.log('Including attachments in streaming request:', uploadedAttachments2.length);
        }

        const response = await fetch(`${API_BASE_URL}/api/chat/stream`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error('Stream request failed');
        }

        responseBox.innerHTML = '';
        responseBox.className = 'response-box streaming';

        // Create container for text content
        let textContainer = document.createElement('div');
        responseBox.appendChild(textContainer);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let currentEventType = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('event: ')) {
              currentEventType = line.slice(7).trim();
              continue;
            }

            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));

                if (currentEventType === 'text' && data.text) {
                  // Append text to current text container
                  textContainer.textContent += data.text;
                  // Auto-scroll to bottom
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (currentEventType === 'tool_call' && data.toolName) {
                  // Create a new text container for the next response
                  textContainer = document.createElement('div');
                  textContainer.style.marginTop = '10px';

                  const toolBadge = document.createElement('div');
                  toolBadge.style.marginTop = '10px';
                  toolBadge.innerHTML = `<span class="event-badge event-tool">üîß TOOL: ${data.toolName}</span>`;
                  responseBox.appendChild(toolBadge);

                  if (data.args && Object.keys(data.args).length > 0) {
                    const argsDiv = document.createElement('div');
                    argsDiv.style.fontSize = '11px';
                    argsDiv.style.color = '#6b7280';
                    argsDiv.style.marginLeft = '10px';
                    argsDiv.textContent = 'Args: ' + JSON.stringify(data.args);
                    responseBox.appendChild(argsDiv);
                  }

                  responseBox.appendChild(textContainer);
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (currentEventType === 'tool_result') {
                  const resultBadge = document.createElement('div');
                  resultBadge.style.marginTop = '5px';
                  resultBadge.innerHTML = `<span class="event-badge event-tool">üìã RESULT</span>`;
                  responseBox.appendChild(resultBadge);

                  // Create a new text container for the next response after tool result
                  textContainer = document.createElement('div');
                  textContainer.style.marginTop = '10px';
                  responseBox.appendChild(textContainer);
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (currentEventType === 'finish' && data.reason) {
                  const finishBadge = document.createElement('div');
                  finishBadge.style.marginTop = '15px';
                  finishBadge.innerHTML = `<span class="event-badge event-finish">‚úì FINISHED</span>`;
                  responseBox.appendChild(finishBadge);

                  if (data.usage || data.messageId) {
                    const meta = document.createElement('div');
                    meta.className = 'meta';
                    meta.innerHTML = `
                      <div><strong>Finish Reason:</strong> ${data.reason}</div>
                      ${data.messageId ? `<div><strong>Message ID:</strong> ${data.messageId}</div>` : ''}
                      ${data.toolCalls?.length ? `<div><strong>Total Tool Calls:</strong> ${data.toolCalls.length}</div>` : ''}
                      ${data.usage?.total_tokens ? `<div><strong>Total Tokens:</strong> ${data.usage.total_tokens}</div>` : ''}
                    `;
                    responseBox.appendChild(meta);
                  }
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (data.error) {
                  throw new Error(data.error);
                }
              } catch (parseError) {
                console.error('Error parsing SSE data:', parseError);
              }
            }
          }
        }
      } catch (error) {
        responseBox.className = 'response-box streaming';
        responseBox.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>