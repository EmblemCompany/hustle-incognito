<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hustle Incognito Test UI</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge {
      font-size: 0.7em;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: normal;
    }
    .badge.streaming {
      background: #10b981;
      color: white;
    }
    .badge.non-streaming {
      background: #3b82f6;
      color: white;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #374151;
      font-weight: 500;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      width: 100%;
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .response-box {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .response-box.streaming {
      background: #f0fdf4;
      border-color: #86efac;
    }
    .loading {
      color: #667eea;
      font-style: italic;
    }
    .error {
      color: #dc2626;
      background: #fee2e2;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .success {
      color: #059669;
    }
    .meta {
      margin-top: 10px;
      padding: 10px;
      background: #eff6ff;
      border-radius: 6px;
      font-size: 12px;
      color: #1e40af;
    }
    .event-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 5px;
    }
    .event-text { background: #dbeafe; color: #1e40af; }
    .event-tool { background: #fef3c7; color: #92400e; }
    .event-finish { background: #d1fae5; color: #065f46; }
    .settings-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }
    .settings-toggle {
      text-align: right;
      margin-bottom: 15px;
    }
    .toggle-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .toggle-btn:hover {
      background: #5568d3;
    }
    .settings-content {
      display: none;
    }
    .settings-content.visible {
      display: block;
    }
    .save-btn {
      margin-top: 15px;
      background: #10b981;
    }
    .save-btn:hover {
      background: #059669;
    }
    .tools-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .tools-content {
      display: none;
    }
    .tools-content.visible {
      display: block;
    }
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .tool-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tool-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    .tool-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .tool-card.disabled {
      opacity: 0.5;
      background: #f9fafb;
    }
    .tool-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .tool-title {
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tool-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .tool-description {
      font-size: 13px;
      color: #6b7280;
      margin-top: 5px;
    }
    .tool-id {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 5px;
      font-family: 'Courier New', monospace;
    }
    .premium-badge {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    .tool-type-header {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-top: 20px;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    .tool-type-header:first-child {
      margin-top: 0;
    }
    .payg-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .payg-content {
      display: none;
    }
    .payg-content.visible {
      display: block;
    }
    .payg-status {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 15px;
    }
    .payg-stat {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .payg-stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .payg-stat-value {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .payg-controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
    @media (max-width: 768px) {
      .payg-status, .payg-controls {
        grid-template-columns: 1fr;
      }
    }
    .payg-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    .payg-toggle label {
      margin: 0;
    }
    .loading-tools {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }
    .file-upload-area {
      margin-top: 10px;
      padding: 10px;
      background: #f9fafb;
      border: 2px dashed #e5e7eb;
      border-radius: 8px;
    }
    .file-upload-area.has-file {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .file-input {
      display: none;
    }
    .file-upload-label {
      display: inline-block;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-right: 10px;
    }
    .file-upload-label:hover {
      background: #5568d3;
    }
    .uploaded-files {
      margin-top: 10px;
    }
    .uploaded-file {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      background: white;
      border-radius: 6px;
      margin-top: 5px;
    }
    .uploaded-file-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .uploaded-file-name {
      font-size: 14px;
      color: #374151;
    }
    .uploaded-file-size {
      font-size: 12px;
      color: #6b7280;
    }
    .remove-file-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    .remove-file-btn:hover {
      background: #dc2626;
    }
    .attachment-preview {
      max-width: 60px;
      max-height: 60px;
      border-radius: 4px;
      object-fit: cover;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }
    .modal-close:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .agent-input-group {
      margin-bottom: 15px;
    }
    .agent-input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #374151;
    }
    .agent-input-group input[type="text"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    .agent-checkbox {
      margin-right: 8px;
    }
    .save-agent-btn {
      padding: 10px 20px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .save-agent-btn:hover {
      background: #059669;
    }

    /* Settings and Agents Grid */
    .top-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .top-section {
        grid-template-columns: 1fr;
      }
    }

    /* Saved Agents Display */
    .saved-agents {
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      min-height: 200px;
    }
    .saved-agents-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .saved-agents-header h3 {
      margin: 0;
      color: #1f2937;
      font-size: 18px;
    }
    .create-agent-btn {
      width: 30px;
      height: 30px;
      padding: 0;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .create-agent-btn:hover {
      background: #059669;
    }
    .agent-card {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .agent-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .agent-info {
      flex-grow: 1;
    }
    .agent-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .agent-details {
      font-size: 12px;
      color: #6b7280;
    }
    .agent-actions {
      display: flex;
      gap: 8px;
    }
    .agent-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    .load-agent-btn {
      background: #3b82f6;
      color: white;
    }
    .load-agent-btn:hover {
      background: #2563eb;
    }
    .delete-agent-btn {
      background: #ef4444;
      color: white;
    }
    .delete-agent-btn:hover {
      background: #dc2626;
    }
    .share-agent-btn {
      background: #8b5cf6;
      color: white;
    }
    .share-agent-btn:hover {
      background: #7c3aed;
    }
    .no-agents {
      text-align: center;
      color: #9ca3af;
      padding: 20px;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .toast {
      background: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 250px;
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
      border-left: 4px solid #3b82f6;
    }
    .toast.success {
      border-left-color: #10b981;
    }
    .toast.error {
      border-left-color: #ef4444;
    }
    .toast.warning {
      border-left-color: #f59e0b;
    }
    .toast.info {
      border-left-color: #3b82f6;
    }
    .toast-icon {
      font-size: 20px;
    }
    .toast-message {
      flex-grow: 1;
      color: #374151;
      font-size: 14px;
    }
    .toast-close {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
    }
    .toast-close:hover {
      color: #4b5563;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    .toast.removing {
      animation: slideOut 0.3s ease-out;
    }

    /* Confirmation Modal */
    .confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1500;
      align-items: center;
      justify-content: center;
    }
    .confirm-modal.active {
      display: flex;
    }
    .confirm-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .confirm-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
    }
    .confirm-message {
      color: #6b7280;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .confirm-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .confirm-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    .confirm-btn-cancel {
      background: #f3f4f6;
      color: #4b5563;
    }
    .confirm-btn-cancel:hover {
      background: #e5e7eb;
    }
    .confirm-btn-confirm {
      background: #3b82f6;
      color: white;
    }
    .confirm-btn-confirm:hover {
      background: #2563eb;
    }
    .confirm-btn-danger {
      background: #ef4444;
      color: white;
    }
    .confirm-btn-danger:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1> Hustle SDK Sandbox & Agent Builder</h1>

    <!-- Top Section: Settings and Agents Side by Side -->
    <div class="top-section">
      <!-- Settings Panel -->
      <div class="settings-panel">
        <div class="settings-toggle">
          <button class="toggle-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
        </div>
        <div id="settingsContent" class="settings-content">
          <h2 style="margin-bottom: 15px;">Configuration</h2>
          <div class="settings-grid">
            <div class="input-group">
              <label for="apiKey">API Key</label>
              <input type="password" id="apiKey" placeholder="Enter API key">
            </div>
            <div class="input-group">
              <label for="baseUrl">Base URL</label>
              <input type="text" id="baseUrl" placeholder="https://agenthustle.ai">
            </div>
            <div class="input-group">
              <label for="defaultVaultId">Default Vault ID</label>
              <input type="text" id="defaultVaultId" placeholder="default">
            </div>
          </div>
          <button class="save-btn" onclick="saveSettings()">üíæ Save Settings</button>
        </div>
      </div>

      <!-- Saved Agents -->
      <div class="saved-agents">
        <div class="saved-agents-header">
          <h3>üìö Saved Agents</h3>
          <button class="create-agent-btn" onclick="openAgentModal()" title="Create New Agent">+</button>
        </div>
        <div id="savedAgentsList">
          <div class="no-agents">No saved agents yet. Create one using the button above!</div>
        </div>
      </div>
    </div>

    <!-- Tools Panel -->
    <div class="tools-panel">
      <div class="settings-toggle">
        <button class="toggle-btn" onclick="toggleTools()">üîß Tool Selection</button>
      </div>
      <div id="toolsContent" class="tools-content">
        <h2 style="margin-bottom: 15px;">Available Tool Categories</h2>
        <div id="toolsLoader" class="loading-tools">Loading tools...</div>
        <div id="toolsList" style="display: none;"></div>
      </div>

    </div>

    <!-- PAYG Billing Panel -->
    <div class="payg-panel">
      <div class="settings-toggle">
        <button class="toggle-btn" onclick="togglePayg()">üí≥ Pay-As-You-Go Billing</button>
      </div>
      <div id="paygContent" class="payg-content">
        <h2 style="margin-bottom: 15px;">PAYG Billing Management</h2>
        <div id="paygLoader" style="text-align: center; padding: 20px; color: #6b7280;">Click to load billing status...</div>
        <div id="paygStatusDisplay" style="display: none;">
          <div class="payg-toggle">
            <label for="paygEnabled">PAYG Enabled:</label>
            <input type="checkbox" id="paygEnabled" onclick="togglePaygEnabled()">
            <span id="paygEnabledLabel">Disabled</span>
          </div>
          <div class="payg-status" id="paygStatusGrid">
            <!-- Populated by JS -->
          </div>
          <div class="payg-controls" id="paygControls" style="display: none;">
            <div class="input-group">
              <label for="paygToken">Payment Token</label>
              <select id="paygToken" onchange="updatePaygToken()">
              </select>
            </div>
            <div class="input-group">
              <label for="paygMode">Payment Mode</label>
              <select id="paygMode" onchange="updatePaygMode()">
                <option value="pay_per_request">Pay Per Request</option>
                <option value="debt_accumulation">Debt Accumulation</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Non-Streaming Panel -->
      <div class="panel">
        <h2>
          Non-Streaming Chat
          <span class="badge non-streaming">Standard</span>
        </h2>
        <form id="nonStreamForm">
          <div class="input-group">
            <label for="systemPrompt1">System Prompt (optional)</label>
            <textarea id="systemPrompt1" placeholder="You are a helpful AI assistant expert in blockchain and cryptocurrency..." rows="3"></textarea>
          </div>
          <div class="input-group">
            <label for="message1">Message</label>
            <textarea id="message1" placeholder="What is Solana?" required></textarea>
          </div>
          <div class="input-group">
            <label for="vaultId1">Vault ID</label>
            <input type="text" id="vaultId1" value="default" placeholder="default">
          </div>
          <div class="file-upload-area" id="uploadArea1">
            <input type="file" id="fileInput1" class="file-input" accept="image/*" multiple>
            <label for="fileInput1" class="file-upload-label">üìé Attach Images</label>
            <span id="fileCount1" style="font-size: 14px; color: #6b7280;"></span>
            <div id="uploadedFiles1" class="uploaded-files"></div>
          </div>
          <button type="submit" id="submitBtn1">Send Message</button>
        </form>
        <div id="response1" class="response-box">Response will appear here...</div>
      </div>

      <!-- Streaming Panel -->
      <div class="panel">
        <h2>
          Streaming Chat
          <span class="badge streaming">SSE</span>
        </h2>
        <form id="streamForm">
          <div class="input-group">
            <label for="systemPrompt2">System Prompt (optional)</label>
            <textarea id="systemPrompt2" placeholder="You are a helpful AI assistant expert in blockchain and cryptocurrency..." rows="3"></textarea>
          </div>
          <div class="input-group">
            <label for="message2">Message</label>
            <textarea id="message2" placeholder="Tell me about Solana tokens" required></textarea>
          </div>
          <div class="input-group">
            <label for="vaultId2">Vault ID</label>
            <input type="text" id="vaultId2" value="default" placeholder="default">
          </div>
          <div class="file-upload-area" id="uploadArea2">
            <input type="file" id="fileInput2" class="file-input" accept="image/*" multiple>
            <label for="fileInput2" class="file-upload-label">üìé Attach Images</label>
            <span id="fileCount2" style="font-size: 14px; color: #6b7280;"></span>
            <div id="uploadedFiles2" class="uploaded-files"></div>
          </div>
          <button type="submit" id="submitBtn2">Stream Message</button>
        </form>
        <div id="response2" class="response-box streaming">Streaming response will appear here...</div>
      </div>
    </div>
  </div>

  <script>
    // Configuration - Update these for your setup
    const API_BASE_URL = window.location.origin; // Uses the same server by default
    const DEFAULT_VAULT_ID = '{{VAULT_ID_PLACEHOLDER}}'; // This will be replaced by the server

    // Toast Notification System
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };

      toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="removeToast(this)">√ó</button>
      `;

      toastContainer.appendChild(toast);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (toast.parentNode) {
          removeToast(toast.querySelector('.toast-close'));
        }
      }, 5000);
    }

    function removeToast(closeBtn) {
      const toast = closeBtn.closest('.toast');
      toast.classList.add('removing');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }

    // Confirmation Dialog System
    let confirmResolver = null;

    function showConfirm(title, message, isDanger = false) {
      return new Promise((resolve) => {
        confirmResolver = resolve;

        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmTitle');
        const messageEl = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmOk');

        titleEl.textContent = title;
        messageEl.textContent = message;

        // Change button style for danger actions
        if (isDanger) {
          confirmBtn.className = 'confirm-btn confirm-btn-danger';
        } else {
          confirmBtn.className = 'confirm-btn confirm-btn-confirm';
        }

        modal.classList.add('active');
      });
    }

    // Make functions globally available
    window.showToast = showToast;
    window.removeToast = removeToast;

    // Load settings from localStorage
    window.loadSettings = function loadSettings() {
      const apiKey = localStorage.getItem('hustle_api_key') || '';
      const baseUrl = localStorage.getItem('hustle_base_url') || '';
      const defaultVaultId = localStorage.getItem('hustle_vault_id') || DEFAULT_VAULT_ID;

      document.getElementById('apiKey').value = apiKey;
      document.getElementById('baseUrl').value = baseUrl;
      document.getElementById('defaultVaultId').value = defaultVaultId;

      // Pre-fill vault ID fields
      document.getElementById('vaultId1').value = defaultVaultId;
      document.getElementById('vaultId2').value = defaultVaultId;
    }

    // Save settings to localStorage
    window.saveSettings = function saveSettings() {
      const apiKey = document.getElementById('apiKey').value;
      const baseUrl = document.getElementById('baseUrl').value;
      const defaultVaultId = document.getElementById('defaultVaultId').value;

      localStorage.setItem('hustle_api_key', apiKey);
      localStorage.setItem('hustle_base_url', baseUrl);
      localStorage.setItem('hustle_vault_id', defaultVaultId);

      // Update vault ID fields
      document.getElementById('vaultId1').value = defaultVaultId;
      document.getElementById('vaultId2').value = defaultVaultId;

      showToast('Settings saved!', 'success');
    }

    // Toggle settings visibility
    window.toggleSettings = function toggleSettings() {
      const content = document.getElementById('settingsContent');
      content.classList.toggle('visible');
    }

    // Get current settings
    function getCurrentSettings() {
      return {
        apiKey: localStorage.getItem('hustle_api_key') || '',
        baseUrl: localStorage.getItem('hustle_base_url') || '',
        vaultId: localStorage.getItem('hustle_vault_id') || DEFAULT_VAULT_ID
      };
    }

    // Load settings on page load
    loadSettings();

    // Tools management
    let availableTools = [];
    let selectedToolIds = [];

    // Load selected tools from localStorage
    function loadToolSelection() {
      const saved = localStorage.getItem('hustle_selected_tools');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          // Validate that it's an array of strings (tool IDs)
          if (Array.isArray(parsed) && parsed.every(id => typeof id === 'string')) {
            // Filter out any invalid values like 'required'
            selectedToolIds = parsed.filter(id => id !== 'required');
            // If we filtered out invalid values, update localStorage
            if (selectedToolIds.length !== parsed.length) {
              localStorage.setItem('hustle_selected_tools', JSON.stringify(selectedToolIds));
              console.log('Cleaned up invalid tool selections from localStorage');
            }
          } else {
            // Invalid format, reset
            selectedToolIds = [];
            localStorage.removeItem('hustle_selected_tools');
            console.log('Reset invalid tool selection format in localStorage');
          }
        } catch (e) {
          // Invalid JSON, reset
          selectedToolIds = [];
          localStorage.removeItem('hustle_selected_tools');
          console.log('Reset corrupted tool selection in localStorage');
        }
      } else {
        selectedToolIds = [];
      }

      // Don't force any tools to be selected

      console.log('Loaded tool selection from localStorage:', selectedToolIds);
    }

    // Toggle tool selection and auto-save
    window.toggleTool = function toggleTool(toolId) {
      // Load current selection from localStorage to ensure we have the latest
      const saved = localStorage.getItem('hustle_selected_tools');
      selectedToolIds = saved ? JSON.parse(saved) : [];

      const index = selectedToolIds.indexOf(toolId);
      if (index > -1) {
        selectedToolIds.splice(index, 1);
      } else {
        selectedToolIds.push(toolId);
      }

      // Save to localStorage immediately
      localStorage.setItem('hustle_selected_tools', JSON.stringify(selectedToolIds));
      console.log('Auto-saved tool selection:', selectedToolIds);

      renderTools();
    }

    // Render tools UI
    function renderTools() {
      const toolsList = document.getElementById('toolsList');
      if (availableTools.length === 0) return;

      // Group tools by type
      const analystTools = availableTools.filter(t => t.type === 'analyst');
      const traderTools = availableTools.filter(t => t.type === 'trader');
      const otherTools = availableTools.filter(t => t.type !== 'analyst' && t.type !== 'trader');

      let html = '';

      if (analystTools.length > 0) {
        html += '<div class="tool-type-header">üìä Analyst Tools</div>';
        html += '<div class="tools-grid">';
        analystTools.forEach(tool => {
          const isSelected = selectedToolIds.includes(tool.id);
          const isDisabled = tool.disabled || false;
          html += `
            <div class="tool-card ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
                 onclick="${!isDisabled ? `toggleTool('${tool.id}')` : ''}">
              <div class="tool-header">
                <div class="tool-title">
                  <input type="checkbox" class="tool-checkbox" ${isSelected ? 'checked' : ''}
                         ${isDisabled ? 'disabled' : ''}>
                  ${tool.title}
                  ${tool.premium ? '<span class="premium-badge">üíé Premium</span>' : ''}
                </div>
              </div>
              <div class="tool-description">${tool.description || 'No description'}</div>
              <div class="tool-id">ID: ${tool.id}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      if (traderTools.length > 0) {
        html += '<div class="tool-type-header">üíπ Trader Tools</div>';
        html += '<div class="tools-grid">';
        traderTools.forEach(tool => {
          const isSelected = selectedToolIds.includes(tool.id);
          const isDisabled = tool.disabled || false;
          const isRequired = tool.id === 'standard-tools' || tool.id === 'trader-standard-tools';
          html += `
            <div class="tool-card ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
                 onclick="${!isDisabled && !isRequired ? `toggleTool('${tool.id}')` : ''}">
              <div class="tool-header">
                <div class="tool-title">
                  <input type="checkbox" class="tool-checkbox" ${isSelected ? 'checked' : ''}
                         ${isDisabled || isRequired ? 'disabled' : ''}>
                  ${tool.title}
                  ${isRequired ? '<span class="premium-badge" style="background: #10b981;">Required</span>' : ''}
                  ${tool.premium && !isRequired ? '<span class="premium-badge">üíé Premium</span>' : ''}
                </div>
              </div>
              <div class="tool-description">${tool.description || 'No description'}</div>
              <div class="tool-id">ID: ${tool.id}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      if (otherTools.length > 0) {
        html += '<div class="tool-type-header">üîß Other Tools</div>';
        html += '<div class="tools-grid">';
        otherTools.forEach(tool => {
          const isSelected = selectedToolIds.includes(tool.id);
          const isDisabled = tool.disabled || false;
          html += `
            <div class="tool-card ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}"
                 onclick="${!isDisabled ? `toggleTool('${tool.id}')` : ''}">
              <div class="tool-header">
                <div class="tool-title">
                  <input type="checkbox" class="tool-checkbox" ${isSelected ? 'checked' : ''}
                         ${isDisabled ? 'disabled' : ''}>
                  ${tool.title}
                  ${tool.premium ? '<span class="premium-badge">üíé Premium</span>' : ''}
                </div>
              </div>
              <div class="tool-description">${tool.description || 'No description'}</div>
              <div class="tool-id">ID: ${tool.id}</div>
            </div>
          `;
        });
        html += '</div>';
      }

      toolsList.innerHTML = html;
    }

    // Fetch available tools
    async function fetchTools() {
      try {
        const settings = getCurrentSettings();
        const headers = {};

        if (settings.apiKey) {
          headers['X-API-Key'] = settings.apiKey;
        }
        if (settings.baseUrl) {
          headers['X-Base-URL'] = settings.baseUrl;
        }

        const response = await fetch(`${API_BASE_URL}/api/tools`, { headers });
        const data = await response.json();

        if (response.ok) {
          availableTools = data.tools || [];
          document.getElementById('toolsLoader').style.display = 'none';
          document.getElementById('toolsList').style.display = 'block';
          // Load saved selection before rendering
          loadToolSelection();
          renderTools();
        } else {
          throw new Error(data.error || 'Failed to fetch tools');
        }
      } catch (error) {
        document.getElementById('toolsLoader').innerHTML = `<div class="error">Error loading tools: ${error.message}</div>`;
      }
    }

    // Toggle tools visibility
    window.toggleTools = function toggleTools() {
      const content = document.getElementById('toolsContent');
      const isVisible = content.classList.toggle('visible');

      // Fetch tools when first opened
      if (isVisible && availableTools.length === 0) {
        fetchTools();
      }
    }

    // Agent Modal Functions
    function openAgentModal() {
      const modal = document.getElementById('agentModal');
      modal.classList.add('active');
      // Focus on the input field
      document.getElementById('agentName').focus();
    }

    function closeAgentModal() {
      const modal = document.getElementById('agentModal');
      modal.classList.remove('active');
      // Clear form
      document.getElementById('agentName').value = '';
      document.getElementById('includeMessage').checked = false;
    }

    function closeAgentModalOnOverlay(event) {
      if (event.target === event.currentTarget) {
        closeAgentModal();
      }
    }

    async function saveAgent() {
      const agentName = document.getElementById('agentName').value.trim();

      if (!agentName) {
        showToast('Please enter an agent name', 'warning');
        return;
      }

      // Get current system prompts from both panels
      const systemPrompt1 = document.getElementById('systemPrompt1').value;
      const systemPrompt2 = document.getElementById('systemPrompt2').value;
      // Use the first non-empty system prompt
      const systemPrompt = systemPrompt1 || systemPrompt2;

      // Get current messages if checkbox is checked
      let message = '';
      if (document.getElementById('includeMessage').checked) {
        const message1 = document.getElementById('message1').value;
        const message2 = document.getElementById('message2').value;
        message = message1 || message2;
      }

      // Get current settings
      const settings = getCurrentSettings();

      // Get selected tools
      const selectedTools = JSON.parse(localStorage.getItem('hustle_selected_tools') || '[]');

      // Create agent configuration
      const agentConfig = {
        id: Date.now().toString(),
        name: agentName,
        systemPrompt: systemPrompt,
        message: message,
        settings: settings,
        selectedTools: selectedTools,
        createdAt: new Date().toISOString()
      };

      // Load existing agents
      const agents = JSON.parse(localStorage.getItem('hustle_saved_agents') || '[]');

      // Check if agent name already exists
      if (agents.some(agent => agent.name === agentName)) {
        const shouldOverwrite = await showConfirm(
          'Overwrite Agent?',
          `Agent "${agentName}" already exists. Do you want to overwrite it?`
        );
        if (!shouldOverwrite) {
          return;
        }
        // Remove existing agent with same name
        const index = agents.findIndex(agent => agent.name === agentName);
        agents.splice(index, 1);
      }

      // Add new agent
      agents.push(agentConfig);

      // Save to localStorage
      localStorage.setItem('hustle_saved_agents', JSON.stringify(agents));

      // Clear form
      document.getElementById('agentName').value = '';
      document.getElementById('includeMessage').checked = false;

      // Reload agent list
      loadSavedAgents();

      // Close modal
      closeAgentModal();

      showToast(`Agent "${agentName}" saved successfully!`, 'success');
    }

    function loadSavedAgents() {
      const agents = JSON.parse(localStorage.getItem('hustle_saved_agents') || '[]');
      const agentsList = document.getElementById('savedAgentsList');

      if (agents.length === 0) {
        agentsList.innerHTML = '<div class="no-agents">No saved agents yet. Create one above!</div>';
        return;
      }

      let html = '';
      agents.forEach(agent => {
        const toolCount = agent.selectedTools ? agent.selectedTools.length : 0;
        const hasSystemPrompt = agent.systemPrompt ? 'Yes' : 'No';
        const hasMessage = agent.message ? 'Yes' : 'No';

        html += `
          <div class="agent-card">
            <div class="agent-info">
              <div class="agent-name">${agent.name}</div>
              <div class="agent-details">
                Tools: ${toolCount} | System Prompt: ${hasSystemPrompt} | Message: ${hasMessage}
              </div>
            </div>
            <div class="agent-actions">
              <button class="agent-btn load-agent-btn" onclick="loadAgent('${agent.id}')">Load</button>
              <button class="agent-btn share-agent-btn" onclick="shareAgent('${agent.id}')">Share</button>
              <button class="agent-btn delete-agent-btn" onclick="deleteAgent('${agent.id}')">Delete</button>
            </div>
          </div>
        `;
      });

      agentsList.innerHTML = html;
    }

    function loadAgent(agentId) {
      const agents = JSON.parse(localStorage.getItem('hustle_saved_agents') || '[]');
      const agent = agents.find(a => a.id === agentId);

      if (!agent) {
        showToast('Agent not found', 'error');
        return;
      }

      // Apply system prompt to both panels
      if (agent.systemPrompt) {
        document.getElementById('systemPrompt1').value = agent.systemPrompt;
        document.getElementById('systemPrompt2').value = agent.systemPrompt;
      }

      // Apply message if exists (to first panel by default)
      if (agent.message) {
        document.getElementById('message1').value = agent.message;
      }

      // Apply settings
      if (agent.settings) {
        if (agent.settings.apiKey) {
          document.getElementById('apiKey').value = agent.settings.apiKey;
        }
        if (agent.settings.baseUrl) {
          document.getElementById('baseUrl').value = agent.settings.baseUrl;
        }
        saveSettings(); // Save to localStorage
      }

      // Apply tool selection
      if (agent.selectedTools && agent.selectedTools.length > 0) {
        selectedToolIds = [...agent.selectedTools];
        localStorage.setItem('hustle_selected_tools', JSON.stringify(selectedToolIds));

        // Update UI if tools are visible
        const toolsContent = document.getElementById('toolsContent');
        if (toolsContent.classList.contains('visible')) {
          displayTools(availableTools);
        }
      }

      showToast(`Agent "${agent.name}" loaded successfully!`, 'success');
    }

    async function deleteAgent(agentId) {
      const agents = JSON.parse(localStorage.getItem('hustle_saved_agents') || '[]');
      const agent = agents.find(a => a.id === agentId);

      if (!agent) {
        showToast('Agent not found', 'error');
        return;
      }

      const shouldDelete = await showConfirm(
        'Delete Agent?',
        `Are you sure you want to delete agent "${agent.name}"?`,
        true // isDanger
      );

      if (!shouldDelete) {
        return;
      }

      // Remove agent
      const index = agents.findIndex(a => a.id === agentId);
      agents.splice(index, 1);

      // Save to localStorage
      localStorage.setItem('hustle_saved_agents', JSON.stringify(agents));

      // Reload agent list
      loadSavedAgents();

      showToast(`Agent "${agent.name}" deleted successfully!`, 'success');
    }

    function shareAgent(agentId) {
      const agents = JSON.parse(localStorage.getItem('hustle_saved_agents') || '[]');
      const agent = agents.find(a => a.id === agentId);
      if (!agent) {
        showToast('Agent not found', 'error');
        return;
      }

      // Create a shareable object without the ID (will be regenerated on import)
      const shareableAgent = {
        name: agent.name,
        systemPrompt: agent.systemPrompt,
        message: agent.message,
        settings: agent.settings,
        selectedTools: agent.selectedTools
      };

      // Encode the agent data as base64
      const encodedAgent = btoa(JSON.stringify(shareableAgent));

      // Create the shareable URL
      const baseUrl = window.location.origin + window.location.pathname;
      const shareUrl = `${baseUrl}#loadAgent/${encodedAgent}`;

      // Copy to clipboard
      navigator.clipboard.writeText(shareUrl).then(() => {
        showToast(`Share link copied to clipboard! Share this link to share agent "${agent.name}"`, 'success');
      }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement("textarea");
        textArea.value = shareUrl;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          document.execCommand('copy');
          showToast(`Share link copied to clipboard! Share this link to share agent "${agent.name}"`, 'success');
        } catch (err) {
          showToast('Failed to copy link to clipboard', 'error');
        }
        document.body.removeChild(textArea);
      });
    }

    // Make functions globally available
    window.openAgentModal = openAgentModal;
    window.closeAgentModal = closeAgentModal;
    window.closeAgentModalOnOverlay = closeAgentModalOnOverlay;
    window.saveAgent = saveAgent;
    window.loadAgent = loadAgent;
    window.deleteAgent = deleteAgent;
    window.shareAgent = shareAgent;

    // Load saved agents on page load
    loadSavedAgents();

    // Load tool selection on page load
    loadToolSelection();

    // Load settings on page load
    loadSettings();

    // PAYG Management
    let paygStatus = null;

    window.togglePayg = function togglePayg() {
      const content = document.getElementById('paygContent');
      const isVisible = content.classList.toggle('visible');
      if (isVisible && !paygStatus) {
        fetchPaygStatus();
      }
    }

    async function fetchPaygStatus() {
      const settings = getCurrentSettings();
      if (!settings.apiKey) {
        document.getElementById('paygLoader').innerHTML = '<div class="error">Please set an API key in Settings first</div>';
        return;
      }

      document.getElementById('paygLoader').textContent = 'Loading billing status...';
      document.getElementById('paygLoader').style.display = 'block';
      document.getElementById('paygStatusDisplay').style.display = 'none';

      try {
        const baseUrl = settings.baseUrl || 'https://agenthustle.ai';
        const response = await fetch(baseUrl + '/api/payg', {
          method: 'GET',
          headers: {
            'x-api-key': settings.apiKey,
            'x-vault-id': settings.vaultId || 'default'
          }
        });

        if (!response.ok) throw new Error('Failed to fetch PAYG status: ' + response.status);

        paygStatus = await response.json();
        renderPaygStatus();
      } catch (error) {
        document.getElementById('paygLoader').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
      }
    }

    function renderPaygStatus() {
      document.getElementById('paygLoader').style.display = 'none';
      document.getElementById('paygStatusDisplay').style.display = 'block';

      const enabled = paygStatus.enabled;
      document.getElementById('paygEnabled').checked = enabled;
      document.getElementById('paygEnabledLabel').textContent = enabled ? 'Enabled' : 'Disabled';
      document.getElementById('paygControls').style.display = enabled ? 'grid' : 'none';

      // Populate token dropdown
      const tokenSelect = document.getElementById('paygToken');
      tokenSelect.innerHTML = '';
      (paygStatus.available_tokens || ['SOL', 'SOL_USDC', 'HUSTLE', 'ETH', 'ETH_USDC', 'BASE_ETH', 'BASE_USDC']).forEach(token => {
        const option = document.createElement('option');
        option.value = token;
        option.textContent = token;
        if (token === paygStatus.payment_token) option.selected = true;
        tokenSelect.appendChild(option);
      });

      // Set mode
      document.getElementById('paygMode').value = paygStatus.mode || 'pay_per_request';

      // Render status grid
      const statusItems = [
        { label: 'Payment Token', value: paygStatus.payment_token || 'N/A' },
        { label: 'Payment Chain', value: paygStatus.payment_chain || 'N/A' },
        { label: 'Total Debt', value: '$' + (paygStatus.total_debt_usd || 0).toFixed(4) },
        { label: 'Total Paid', value: '$' + (paygStatus.total_paid_usd || 0).toFixed(4) },
        { label: 'Debt Ceiling', value: '$' + (paygStatus.debt_ceiling_usd || 0).toFixed(2) },
        { label: 'Pending Charges', value: String(paygStatus.pending_charges || 0) },
        { label: 'Mode', value: (paygStatus.mode || 'N/A').replace('_', ' ') },
        { label: 'Status', value: paygStatus.is_blocked ? 'Blocked' : 'Active' }
      ];
      const gridEl = document.getElementById('paygStatusGrid');
      gridEl.innerHTML = '';
      statusItems.forEach(s => {
        const stat = document.createElement('div');
        stat.className = 'payg-stat';
        const lbl = document.createElement('div');
        lbl.className = 'payg-stat-label';
        lbl.textContent = s.label;
        const val = document.createElement('div');
        val.className = 'payg-stat-value';
        val.textContent = s.value;
        stat.appendChild(lbl);
        stat.appendChild(val);
        gridEl.appendChild(stat);
      });
    }

    async function configurePayg(options) {
      const settings = getCurrentSettings();
      if (!settings.apiKey) return;

      try {
        const baseUrl = settings.baseUrl || 'https://agenthustle.ai';
        const response = await fetch(baseUrl + '/api/payg', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': settings.apiKey,
            'x-vault-id': settings.vaultId || 'default'
          },
          body: JSON.stringify(options)
        });

        if (!response.ok) throw new Error('Failed to configure PAYG: ' + response.status);

        const result = await response.json();
        if (result.success) {
          showToast('PAYG configuration updated', 'success');
          await fetchPaygStatus();
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    window.togglePaygEnabled = function() {
      const enabled = document.getElementById('paygEnabled').checked;
      configurePayg({ enabled });
    }

    window.updatePaygToken = function() {
      const token = document.getElementById('paygToken').value;
      configurePayg({ payment_token: token });
    }

    window.updatePaygMode = function() {
      const mode = document.getElementById('paygMode').value;
      configurePayg({ mode });
    }

    // Check for shared agent in URL
    function checkForSharedAgent() {
      const hash = window.location.hash;
      if (hash.startsWith('#loadAgent/')) {
        const encodedAgent = hash.slice('#loadAgent/'.length);
        try {
          // Decode base64 and parse JSON
          const agentData = JSON.parse(atob(encodedAgent));

          // Generate a new ID for the imported agent
          const agentId = 'agent_' + Date.now() + '_' + Math.random().toString(36).substring(7);
          const importedAgent = {
            ...agentData,
            id: agentId
          };

          // Check if agent with same name already exists
          const agents = JSON.parse(localStorage.getItem('hustle_saved_agents') || '[]');
          const existingAgent = agents.find(a => a.name === agentData.name);

          if (existingAgent) {
            showConfirm(
              'Agent Already Exists',
              `An agent named "${agentData.name}" already exists. Do you want to replace it?`
            ).then(shouldReplace => {
              if (shouldReplace) {
                // Replace existing agent
                const index = agents.findIndex(a => a.name === agentData.name);
                agents[index] = importedAgent;
                localStorage.setItem('hustle_saved_agents', JSON.stringify(agents));
                loadSavedAgents();
                showToast(`Agent "${agentData.name}" imported and replaced successfully!`, 'success');
                // Load the imported agent
                loadAgent(importedAgent.id);
              }
            });
          } else {
            // Add new agent
            agents.push(importedAgent);
            localStorage.setItem('hustle_saved_agents', JSON.stringify(agents));
            loadSavedAgents();
            showToast(`Agent "${agentData.name}" imported successfully!`, 'success');
            // Load the imported agent
            loadAgent(importedAgent.id);
          }

          // Clear the hash from URL
          window.history.replaceState(null, '', window.location.pathname + window.location.search);
        } catch (error) {
          console.error('Failed to import agent:', error);
          showToast('Failed to import agent from URL', 'error');
        }
      }
    }

    // Check for shared agent on page load
    checkForSharedAgent();

    // Also check when hash changes
    window.addEventListener('hashchange', checkForSharedAgent);

    // File upload handling
    let uploadedAttachments1 = [];
    let uploadedAttachments2 = [];

    // Handle file selection for panel 1
    document.getElementById('fileInput1').addEventListener('change', async function(e) {
      await handleFileUpload(e.target.files, 1);
    });

    // Handle file selection for panel 2
    document.getElementById('fileInput2').addEventListener('change', async function(e) {
      await handleFileUpload(e.target.files, 2);
    });

    // Upload files and manage attachments
    async function handleFileUpload(files, panelNum) {
      const uploadArea = document.getElementById(`uploadArea${panelNum}`);
      const fileCount = document.getElementById(`fileCount${panelNum}`);
      const uploadedFilesDiv = document.getElementById(`uploadedFiles${panelNum}`);
      const attachments = panelNum === 1 ? uploadedAttachments1 : uploadedAttachments2;

      for (let file of files) {
        if (!file.type.startsWith('image/')) {
          showToast(`File ${file.name} is not an image. Only images are supported.`, 'error');
          continue;
        }

        // Show uploading status
        fileCount.textContent = 'Uploading...';

        try {
          // Upload file to server
          const formData = new FormData();
          formData.append('file', file);

          const settings = getCurrentSettings();
          const headers = {};

          if (settings.apiKey) {
            headers['X-API-Key'] = settings.apiKey;
          }
          if (settings.baseUrl) {
            headers['X-Base-URL'] = settings.baseUrl;
          }

          const response = await fetch('/api/upload', {
            method: 'POST',
            headers: headers,
            body: formData
          });

          const result = await response.json();

          if (response.ok && result.success) {
            // Add to attachments
            attachments.push(result.attachment);

            // Create preview element
            const fileDiv = document.createElement('div');
            fileDiv.className = 'uploaded-file';
            fileDiv.innerHTML = `
              <div class="uploaded-file-info">
                <img src="${result.attachment.url}" alt="${result.attachment.name}" class="attachment-preview">
                <div>
                  <div class="uploaded-file-name">${result.attachment.name}</div>
                  <div class="uploaded-file-size">${formatFileSize(file.size)}</div>
                </div>
              </div>
              <button class="remove-file-btn" onclick="removeAttachment(${panelNum}, '${result.attachment.url}')">Remove</button>
            `;
            uploadedFilesDiv.appendChild(fileDiv);

            uploadArea.classList.add('has-file');
          } else {
            throw new Error(result.error || 'Upload failed');
          }
        } catch (error) {
          console.error('Upload error:', error);
          showToast(`Failed to upload ${file.name}: ${error.message}`, 'error');
        }
      }

      // Update file count
      const count = attachments.length;
      fileCount.textContent = count > 0 ? `${count} file(s) attached` : '';

      // Clear the file input
      document.getElementById(`fileInput${panelNum}`).value = '';
    }

    // Remove attachment
    window.removeAttachment = function(panelNum, url) {
      const attachments = panelNum === 1 ? uploadedAttachments1 : uploadedAttachments2;
      const index = attachments.findIndex(a => a.url === url);

      if (index > -1) {
        attachments.splice(index, 1);
      }

      // Rebuild UI
      const uploadedFilesDiv = document.getElementById(`uploadedFiles${panelNum}`);
      const uploadArea = document.getElementById(`uploadArea${panelNum}`);
      const fileCount = document.getElementById(`fileCount${panelNum}`);

      uploadedFilesDiv.innerHTML = '';
      attachments.forEach(attachment => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'uploaded-file';
        fileDiv.innerHTML = `
          <div class="uploaded-file-info">
            <img src="${attachment.url}" alt="${attachment.name}" class="attachment-preview">
            <div>
              <div class="uploaded-file-name">${attachment.name}</div>
            </div>
          </div>
          <button class="remove-file-btn" onclick="removeAttachment(${panelNum}, '${attachment.url}')">Remove</button>
        `;
        uploadedFilesDiv.appendChild(fileDiv);
      });

      // Update file count
      const count = attachments.length;
      fileCount.textContent = count > 0 ? `${count} file(s) attached` : '';

      if (count === 0) {
        uploadArea.classList.remove('has-file');
      }
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Non-streaming form handler
    document.getElementById('nonStreamForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const message = document.getElementById('message1').value;
      const systemPrompt = document.getElementById('systemPrompt1').value;
      const vaultId = document.getElementById('vaultId1').value;
      const responseBox = document.getElementById('response1');
      const submitBtn = document.getElementById('submitBtn1');

      responseBox.textContent = 'Sending request...';
      responseBox.className = 'response-box loading';
      submitBtn.disabled = true;

      try {
        const settings = getCurrentSettings();
        const headers = { 'Content-Type': 'application/json' };

        // Add custom headers if settings are provided
        if (settings.apiKey) {
          headers['X-API-Key'] = settings.apiKey;
        }
        if (settings.baseUrl) {
          headers['X-Base-URL'] = settings.baseUrl;
        }

        const requestBody = { message, vaultId };
        if (systemPrompt && systemPrompt.trim()) {
          requestBody.systemPrompt = systemPrompt.trim();
        }

        // Load selected tools from localStorage and add to request
        const savedTools = localStorage.getItem('hustle_selected_tools');
        const currentSelectedTools = savedTools ? JSON.parse(savedTools) : [];

        // Add selected tools if any
        if (currentSelectedTools.length > 0) {
          requestBody.selectedToolCategories = currentSelectedTools;
          console.log('Including selected tools in request:', currentSelectedTools);
        }

        // Add attachments if any
        if (uploadedAttachments1.length > 0) {
          requestBody.attachments = uploadedAttachments1;
          console.log('Including attachments in request:', uploadedAttachments1.length);
        }

        const response = await fetch(`${API_BASE_URL}/api/chat`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        if (response.ok) {
          responseBox.className = 'response-box success';
          responseBox.innerHTML = '';

          // Display main response content
          if (data.content) {
            const contentDiv = document.createElement('div');
            contentDiv.textContent = data.content;
            responseBox.appendChild(contentDiv);
          }

          // Display tool calls if any
          if (data.toolCalls && data.toolCalls.length > 0) {
            const toolsSection = document.createElement('div');
            toolsSection.style.marginTop = '15px';

            const toolsHeader = document.createElement('div');
            toolsHeader.style.fontWeight = 'bold';
            toolsHeader.style.marginBottom = '8px';
            toolsHeader.style.color = '#92400e';
            toolsHeader.textContent = 'üîß Tool Calls:';
            toolsSection.appendChild(toolsHeader);

            data.toolCalls.forEach((tool, index) => {
              const toolDiv = document.createElement('div');
              toolDiv.style.marginLeft = '10px';
              toolDiv.style.marginBottom = '8px';
              toolDiv.style.padding = '8px';
              toolDiv.style.background = '#fef3c7';
              toolDiv.style.borderRadius = '4px';
              toolDiv.style.fontSize = '12px';

              const toolName = document.createElement('div');
              toolName.style.fontWeight = '600';
              toolName.textContent = `${index + 1}. ${tool.toolName || 'Unknown'}`;
              toolDiv.appendChild(toolName);

              if (tool.args && Object.keys(tool.args).length > 0) {
                const argsDiv = document.createElement('div');
                argsDiv.style.fontSize = '11px';
                argsDiv.style.color = '#6b7280';
                argsDiv.style.marginTop = '4px';
                argsDiv.textContent = 'Args: ' + JSON.stringify(tool.args);
                toolDiv.appendChild(argsDiv);
              }

              toolsSection.appendChild(toolDiv);
            });

            responseBox.appendChild(toolsSection);
          }

          // Display tool results if any
          if (data.toolResults && data.toolResults.length > 0) {
            const resultsSection = document.createElement('div');
            resultsSection.style.marginTop = '10px';

            const resultsHeader = document.createElement('div');
            resultsHeader.style.fontWeight = 'bold';
            resultsHeader.style.marginBottom = '8px';
            resultsHeader.style.color = '#065f46';
            resultsHeader.textContent = 'üìã Tool Results:';
            resultsSection.appendChild(resultsHeader);

            data.toolResults.forEach((result, index) => {
              const resultDiv = document.createElement('div');
              resultDiv.style.marginLeft = '10px';
              resultDiv.style.marginBottom = '8px';
              resultDiv.style.padding = '8px';
              resultDiv.style.background = '#d1fae5';
              resultDiv.style.borderRadius = '4px';
              resultDiv.style.fontSize = '12px';

              const resultHeader = document.createElement('div');
              resultHeader.style.fontWeight = '600';
              resultHeader.textContent = `${index + 1}. Result for: ${result.toolName || 'Unknown'}`;
              resultDiv.appendChild(resultHeader);

              if (result.result) {
                const resultContent = document.createElement('div');
                resultContent.style.fontSize = '11px';
                resultContent.style.color = '#374151';
                resultContent.style.marginTop = '4px';
                resultContent.style.maxHeight = '100px';
                resultContent.style.overflow = 'auto';
                resultContent.textContent = typeof result.result === 'string'
                  ? result.result
                  : JSON.stringify(result.result, null, 2);
                resultDiv.appendChild(resultContent);
              }

              resultsSection.appendChild(resultDiv);
            });

            responseBox.appendChild(resultsSection);
          }

          // Display metadata
          if (data.messageId || data.usage || data.pathInfo) {
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.innerHTML = `
              ${data.messageId ? `<div><strong>Message ID:</strong> ${data.messageId}</div>` : ''}
              ${data.toolCalls?.length ? `<div><strong>Total Tool Calls:</strong> ${data.toolCalls.length}</div>` : ''}
              ${data.usage?.total_tokens ? `<div><strong>Total Tokens:</strong> ${data.usage.total_tokens}</div>` : ''}
              ${data.pathInfo ? `<div><strong>Path:</strong> ${data.pathInfo.path || 'N/A'}</div>` : ''}
            `;
            responseBox.appendChild(meta);
          }
        } else {
          throw new Error(data.error || 'Request failed');
        }
      } catch (error) {
        responseBox.className = 'response-box';
        responseBox.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Streaming form handler
    document.getElementById('streamForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const message = document.getElementById('message2').value;
      const systemPrompt = document.getElementById('systemPrompt2').value;
      const vaultId = document.getElementById('vaultId2').value;
      const responseBox = document.getElementById('response2');
      const submitBtn = document.getElementById('submitBtn2');

      responseBox.textContent = 'Connecting to stream...';
      responseBox.className = 'response-box streaming loading';
      submitBtn.disabled = true;

      try {
        const settings = getCurrentSettings();
        const headers = { 'Content-Type': 'application/json' };

        // Add custom headers if settings are provided
        if (settings.apiKey) {
          headers['X-API-Key'] = settings.apiKey;
        }
        if (settings.baseUrl) {
          headers['X-Base-URL'] = settings.baseUrl;
        }

        const requestBody = { message, vaultId };
        if (systemPrompt && systemPrompt.trim()) {
          requestBody.systemPrompt = systemPrompt.trim();
        }

        // Load selected tools from localStorage and add to request
        const savedTools = localStorage.getItem('hustle_selected_tools');
        const currentSelectedTools = savedTools ? JSON.parse(savedTools) : [];

        // Add selected tools if any
        if (currentSelectedTools.length > 0) {
          requestBody.selectedToolCategories = currentSelectedTools;
          console.log('Including selected tools in streaming request:', currentSelectedTools);
        }

        // Add attachments if any
        if (uploadedAttachments2.length > 0) {
          requestBody.attachments = uploadedAttachments2;
          console.log('Including attachments in streaming request:', uploadedAttachments2.length);
        }

        const response = await fetch(`${API_BASE_URL}/api/chat/stream`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          throw new Error('Stream request failed');
        }

        responseBox.innerHTML = '';
        responseBox.className = 'response-box streaming';

        // Create container for text content
        let textContainer = document.createElement('div');
        responseBox.appendChild(textContainer);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let currentEventType = null;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('event: ')) {
              currentEventType = line.slice(7).trim();
              continue;
            }

            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));

                if (currentEventType === 'text' && data.text) {
                  // Append text to current text container
                  textContainer.textContent += data.text;
                  // Auto-scroll to bottom
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (currentEventType === 'tool_call' && data.toolName) {
                  // Create a new text container for the next response
                  textContainer = document.createElement('div');
                  textContainer.style.marginTop = '10px';

                  const toolBadge = document.createElement('div');
                  toolBadge.style.marginTop = '10px';
                  toolBadge.innerHTML = `<span class="event-badge event-tool">üîß TOOL: ${data.toolName}</span>`;
                  responseBox.appendChild(toolBadge);

                  if (data.args && Object.keys(data.args).length > 0) {
                    const argsDiv = document.createElement('div');
                    argsDiv.style.fontSize = '11px';
                    argsDiv.style.color = '#6b7280';
                    argsDiv.style.marginLeft = '10px';
                    argsDiv.textContent = 'Args: ' + JSON.stringify(data.args);
                    responseBox.appendChild(argsDiv);
                  }

                  responseBox.appendChild(textContainer);
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (currentEventType === 'tool_result') {
                  const resultBadge = document.createElement('div');
                  resultBadge.style.marginTop = '5px';
                  resultBadge.innerHTML = `<span class="event-badge event-tool">üìã RESULT</span>`;
                  responseBox.appendChild(resultBadge);

                  // Create a new text container for the next response after tool result
                  textContainer = document.createElement('div');
                  textContainer.style.marginTop = '10px';
                  responseBox.appendChild(textContainer);
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (currentEventType === 'finish' && data.reason) {
                  const finishBadge = document.createElement('div');
                  finishBadge.style.marginTop = '15px';
                  finishBadge.innerHTML = `<span class="event-badge event-finish">‚úì FINISHED</span>`;
                  responseBox.appendChild(finishBadge);

                  if (data.usage || data.messageId) {
                    const meta = document.createElement('div');
                    meta.className = 'meta';
                    meta.innerHTML = `
                      <div><strong>Finish Reason:</strong> ${data.reason}</div>
                      ${data.messageId ? `<div><strong>Message ID:</strong> ${data.messageId}</div>` : ''}
                      ${data.toolCalls?.length ? `<div><strong>Total Tool Calls:</strong> ${data.toolCalls.length}</div>` : ''}
                      ${data.usage?.total_tokens ? `<div><strong>Total Tokens:</strong> ${data.usage.total_tokens}</div>` : ''}
                    `;
                    responseBox.appendChild(meta);
                  }
                  responseBox.scrollTop = responseBox.scrollHeight;
                } else if (data.error) {
                  throw new Error(data.error);
                }
              } catch (parseError) {
                console.error('Error parsing SSE data:', parseError);
              }
            }
          }
        }
      } catch (error) {
        responseBox.className = 'response-box streaming';
        responseBox.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Set up confirmation modal handlers
    document.addEventListener('DOMContentLoaded', () => {
      const confirmModal = document.getElementById('confirmModal');
      const cancelBtn = document.getElementById('confirmCancel');
      const confirmBtn = document.getElementById('confirmOk');

      cancelBtn.addEventListener('click', () => {
        confirmModal.classList.remove('active');
        if (confirmResolver) {
          confirmResolver(false);
          confirmResolver = null;
        }
      });

      confirmBtn.addEventListener('click', () => {
        confirmModal.classList.remove('active');
        if (confirmResolver) {
          confirmResolver(true);
          confirmResolver = null;
        }
      });

      confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
          confirmModal.classList.remove('active');
          if (confirmResolver) {
            confirmResolver(false);
            confirmResolver = null;
          }
        }
      });
    });
  </script>

  <!-- Agent Creator Modal -->
  <div id="agentModal" class="modal-overlay" onclick="closeAgentModalOnOverlay(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">ü§ñ Create Agent</h2>
        <button class="modal-close" onclick="closeAgentModal()">√ó</button>
      </div>
      <div class="agent-input-group">
        <label for="agentName">Agent Name</label>
        <input type="text" id="agentName" placeholder="Enter agent name...">
      </div>
      <div class="agent-input-group">
        <label>
          <input type="checkbox" id="includeMessage" class="agent-checkbox">
          Include current message in configuration
        </label>
      </div>
      <button class="save-agent-btn" onclick="saveAgent()">Save Agent</button>
    </div>
  </div>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="confirm-modal">
    <div class="confirm-content">
      <div id="confirmTitle" class="confirm-title">Confirm Action</div>
      <div id="confirmMessage" class="confirm-message">Are you sure?</div>
      <div class="confirm-buttons">
        <button id="confirmCancel" class="confirm-btn confirm-btn-cancel">Cancel</button>
        <button id="confirmOk" class="confirm-btn confirm-btn-confirm">Confirm</button>
      </div>
    </div>
  </div>
</body>
</html>